name: Ubuntu RDP (Fixed)

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Update & Install Desktop (Final Fix)
        run: |
          sudo apt update
          # Installing XFCE, XRDP, and essential DBUS/XORG packages to fix the session error
          sudo apt install -y xfce4 xfce4-goodies xrdp dbus-x11 xorg xorgxrdp
          sudo systemctl enable xrdp
          sudo systemctl start xrdp

      - name: Create User & Fix Permissions
        run: |
          # 1. Create new user (null-RDP)
          sudo useradd -m -s /bin/bash null-RDP
          
          # 2. Set password (null@1337)
          echo "null-RDP:null@1337" | sudo chpasswd
          
          # 3. Grant sudo permissions
          sudo usermod -aG sudo null-RDP
          
          # 4. Configure XFCE Session correctly
          # This forces XFCE to start properly when connecting via RDP
          echo "xfce4-session" > /home/null-RDP/.xsession
          
          # 5. Fix Ownership and Permissions (The most important part!)
          sudo chown null-RDP:null-RDP /home/null-RDP/.xsession
          sudo chmod +x /home/null-RDP/.xsession
          
          # 6. Restart XRDP service to apply changes
          sudo service xrdp restart

      - name: Setup Tailscale
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          # Download and connect Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey $TAILSCALE_AUTHKEY --hostname "github-ubuntu-rdp" --accept-routes

      - name: Keep Alive (6 Hours)
        run: |
          echo "=========================================="
          echo "âœ… Ubuntu RDP is Running!"
          echo "User: null-RDP"
          echo "Pass: null@1337"
          echo "IP: Check Tailscale Dashboard"
          echo "=========================================="
          # 6 hours loop
          sleep 21600
          
