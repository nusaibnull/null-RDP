name: Ubuntu RDP (Env Fix)

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Update & Install Desktop
        run: |
          sudo apt update
          # Installing XFCE, XRDP and required system components
          sudo apt install -y xfce4 xfce4-goodies xrdp dbus-x11 xorg xorgxrdp x11-xserver-utils
          sudo systemctl enable xrdp
          sudo systemctl start xrdp

      - name: Create User & Fix Environment Variables
        run: |
          # 1. Create User
          sudo useradd -m -s /bin/bash null-RDP
          echo "null-RDP:null@1337" | sudo chpasswd
          sudo usermod -aG sudo null-RDP
          
          # 2. THE FIX: Force Environment Variables in .xsession
          # This fixes the "must include /etc" error
          echo "export XDG_CONFIG_DIRS=/etc/xdg" | sudo tee /home/null-RDP/.xsession
          echo "export XDG_DATA_DIRS=/usr/share" | sudo tee -a /home/null-RDP/.xsession
          echo "export XDG_CONFIG_HOME=/home/null-RDP/.config" | sudo tee -a /home/null-RDP/.xsession
          echo "exec /usr/bin/startxfce4" | sudo tee -a /home/null-RDP/.xsession
          
          # 3. Permissions
          sudo chown null-RDP:null-RDP /home/null-RDP/.xsession
          sudo chmod +x /home/null-RDP/.xsession
          
          # 4. Extra Fix: Force it in XRDP startup script too
          # Adding the fix to the top of the startwm.sh file
          sudo sed -i '3 i export XDG_CONFIG_DIRS=/etc/xdg' /etc/xrdp/startwm.sh
          
          # 5. Restart Services
          sudo service xrdp restart

      - name: Setup Tailscale
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey $TAILSCALE_AUTHKEY --hostname "github-ubuntu-rdp" --accept-routes

      - name: Keep Alive (6 Hours)
        run: |
          echo "=========================================="
          echo "âœ… Ubuntu RDP Running (Env Fixed)"
          echo "User: null-RDP"
          echo "Pass: null@1337"
          echo "IP: Check Tailscale Dashboard"
          echo "=========================================="
          sleep 21600
