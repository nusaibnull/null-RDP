name: Kali Linux (Simple Mode)

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install Desktop (XFCE)
        run: |
          sudo apt update
          # বেসিক ডেস্কটপ এবং XRDP ইন্সটল
          sudo apt install -y xfce4 xfce4-goodies xrdp dbus-x11
          
      - name: Create User (kali:kali)
        run: |
          # ১. ইউজার kali তৈরি
          sudo useradd -m -s /bin/bash kali
          # ২. পাসওয়ার্ড সেট করা: kali
          echo "kali:kali" | sudo chpasswd
          # ৩. সুডো পাওয়ার দেওয়া
          sudo usermod -aG sudo kali

      - name: Force Start XFCE (The Magic Fix)
        run: |
          # কোনো .xsession ফাইল লাগবে না, আমরা মেইন ফাইল এডিট করে দিচ্ছি
          # এই কমান্ডগুলো RDP কে বাধ্য করবে XFCE ওপেন করতে
          sudo sed -i 's/test -x \/etc\/X11\/Xsession/#test -x \/etc\/X11\/Xsession/g' /etc/xrdp/startwm.sh
          sudo sed -i 's/exec \/bin\/sh \/etc\/X11\/Xsession/#exec \/bin\/sh \/etc\/X11\/Xsession/g' /etc/xrdp/startwm.sh
          echo "startxfce4" | sudo tee -a /etc/xrdp/startwm.sh
          
          # সার্ভিস চালু
          sudo systemctl enable xrdp
          sudo systemctl start xrdp

      - name: Setup Tailscale
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey $TAILSCALE_AUTHKEY --hostname "github-kali" --accept-routes

      - name: Keep Alive (6 Hours)
        run: |
          echo "=========================================="
          echo "✅ RDP Ready!"
          echo "User: kali"
          echo "Pass: kali"
          echo "IP: Check Tailscale Dashboard"
          echo "=========================================="
          sleep 21600
          
